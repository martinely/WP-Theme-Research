name: Research QA

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, synchronize, reopened ]
    paths:
      - "niches/**"
      - ".github/workflows/research_qa.yml"
  workflow_dispatch:
    inputs:
      niche:
        description: "Validate a single niche folder under /niches (e.g., counseling). Leave empty to validate all."
        required: false
        default: ""
      phase:
        description: "sources = only sources must be valid; prompts = prompts must be non-empty too"
        required: false
        default: "sources"

permissions:
  contents: read

jobs:
  validate-research-structure:
    runs-on: ubuntu-latest
    env:
      NICHE_INPUT: ${{ inputs.niche }}
      PHASE_INPUT: ${{ inputs.phase }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate niche structure + required artifacts
        shell: bash
        run: |
          set -euo pipefail

          PHASE="${PHASE_INPUT:-sources}"
          if [[ "$PHASE" != "sources" && "$PHASE" != "prompts" ]]; then
            echo "❌ Invalid phase: $PHASE (use sources|prompts)"
            exit 1
          fi

          echo "NICHE_INPUT='${NICHE_INPUT:-}'"
          echo "PHASE='$PHASE'"

          if [[ -n "${NICHE_INPUT:-}" ]]; then
            NICHES=( "niches/${NICHE_INPUT}" )
          else
            mapfile -t NICHES < <(find niches -mindepth 1 -maxdepth 1 -type d | sort)
          fi

          if [[ "${#NICHES[@]}" -eq 0 ]]; then
            echo "❌ No niche folders found under /niches."
            exit 1
          fi

          # Always-required (structure must exist)
          REQUIRED_ALWAYS=(
            "00_results/00_RESULTS_working.md"
            "research/TF-01_Screening.md"
            "research/TF-02_Winner_Deep_Dive.md"
            "research/REAL-SUM-CLEAN.md"
            "research/SYN-01_Blueprint.md"
            "appendices/Appendix_INNER_Master_Subpages.md"
          )

          # Prompts expected in Option A (can be empty in PHASE=sources)
          REQUIRED_PROMPTS=(
            "prompts/FIGMA-01_prompt.txt"
            "prompts/HOME_01_prompt.txt"
            "prompts/HOME_02_prompt.txt"
            "prompts/HOME_03_prompt.txt"
            "prompts/INNER-00_about_prompt.txt"
            "prompts/INNER-01_services_prompt.txt"
            "prompts/INNER-02_service_single_prompt.txt"
          )

          # Sources must exist + contain at least one URL line
          REQUIRED_SOURCES_URL=(
            "sources/TF_LINKS.txt"
            "sources/HOME_01_URL_POOL.txt"
            "sources/HOME_02_URL_POOL.txt"
            "sources/HOME_03_URL_POOL.txt"
          )

          fail=0

          has_real_url_line() {
            local f="$1"
            [[ -f "$f" ]] || return 1
            grep -E '^\s*https?://' "$f" >/dev/null 2>&1
          }

          check_figma_len() {
            local f="$1"
            [[ -f "$f" ]] || return 1
            local n
            n=$(wc -c < "$f" | tr -d ' ')
            if [[ "$n" -gt 5000 ]]; then
              echo "❌ FIGMA prompt too long: $f (${n} chars > 5000)"
              return 1
            fi
            return 0
          }

          for niche_dir in "${NICHES[@]}"; do
            echo ""
            echo "== Validating: $niche_dir =="

            # 1) Always required files exist (can be placeholder)
            for rel in "${REQUIRED_ALWAYS[@]}"; do
              p="${niche_dir}/${rel}"
              if [[ ! -f "$p" ]]; then
                echo "❌ Missing required file: $p"
                fail=1
              fi
            done

            # 2) Prompts must exist; non-empty only in PHASE=prompts
            for rel in "${REQUIRED_PROMPTS[@]}"; do
              p="${niche_dir}/${rel}"
              if [[ ! -f "$p" ]]; then
                echo "❌ Missing required prompt file: $p"
                fail=1
                continue
              fi

              if [[ "$PHASE" == "prompts" ]]; then
                if [[ ! -s "$p" ]]; then
                  echo "❌ Prompt file is empty (PHASE=prompts): $p"
                  fail=1
                fi
              fi
            done

            # 3) FIGMA prompt length check only if non-empty (or in prompts phase)
            if [[ "$PHASE" == "prompts" || -s "${niche_dir}/prompts/FIGMA-01_prompt.txt" ]]; then
              if ! check_figma_len "${niche_dir}/prompts/FIGMA-01_prompt.txt"; then
                fail=1
              fi
            fi

            # 4) Sources must exist + contain at least one URL
            for rel in "${REQUIRED_SOURCES_URL[@]}"; do
              p="${niche_dir}/${rel}"
              if [[ ! -f "$p" ]]; then
                echo "❌ Missing required sources file: $p"
                fail=1
                continue
              fi
              if ! has_real_url_line "$p"; then
                echo "❌ Sources file must contain at least one URL line (https://...): $p"
                fail=1
              fi
            done
          done

          if [[ "$fail" -eq 1 ]]; then
            echo ""
            echo "❌ Research QA failed."
            exit 1
          fi

          echo ""
          echo "✅ Research QA passed for: ${NICHES[*]} (phase=$PHASE)"
